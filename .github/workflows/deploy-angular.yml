name: Deploy Angular
on:
  workflow_call:
    inputs:
      host:
        required: true
        type: string
      base-href:
        required: true
        type: string
      project-name:
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "16"

      - name: Install Dependencies
        run: npm ci

      - name: Build
        run: npm run build -- --base-href=${{ inputs.base-href }}

      - name: Compress Artifact
        run: tar -czf artifact.tar.gz -C dist .

      - uses: actions/upload-artifact@v4
        with:
          name: artifact
          path: artifact.tar.gz

  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: artifact

      - name: Recreate dist Directory
        run: rm -rf dist && mkdir dist

      - name: Decompress Artifact
        run: tar -xzf artifact.tar.gz -C dist

      - name: Remove Previous Deploy Folder
        run: rm -rf /var/www/${{ inputs.host }}/html${{ inputs.base-href }}

      - name: Create Deploy Folder
        run: mkdir -p /var/www/${{ inputs.host }}/html${{ inputs.base-href }}

      - name: Move Built Files to Deploy Folder
        run: mv dist/${{ inputs.project-name }}/* /var/www/${{ inputs.host }}/html${{ inputs.base-href }}
