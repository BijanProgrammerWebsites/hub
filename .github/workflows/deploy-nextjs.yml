name: Deploy Next.js
on:
  workflow_call:
    inputs:
      process-name:
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Prepare Artifact
        run: |
          mkdir artifact
          cp -r .next/standalone/* artifact/
          mkdir -p artifact/.next
          cp -r .next/static artifact/.next/static
          [ -d public ] && cp -r public artifact/

      - name: Compress Artifact
        run: tar -czf artifact.tar.gz -C artifact .

      - uses: actions/upload-artifact@v4
        with:
          name: artifact
          path: artifact.tar.gz

  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: artifact

      - name: Recreate app Directory
        run: rm -rf app && mkdir app

      - name: Decompress Artifact
        run: tar -xzf artifact.tar.gz -C app

      - name: Fill Out the .env File
        run: echo "${{ secrets.ENV_FILE }}" > app/.env

      - name: Fill Out the .env.local File
        run: echo "${{ secrets.ENV_LOCAL_FILE }}" > app/.env.local

      - name: Install Dependencies
        run: cd app && npm install --omit=dev

      - name: Delete Previous Process Silently
        continue-on-error: true
        run: pm2 delete "${{ inputs.process-name }}"

      - name: Start a New Process
        run: cd app && pm2 start server.js --name "${{ inputs.process-name }}"

      - name: Save Current Process List
        run: pm2 save
